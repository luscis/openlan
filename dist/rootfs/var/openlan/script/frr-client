#!/usr/bin/env python3

import argparse
import socket
import sys

SOCKET_PATH = "/var/openlan/frr/reloader.sock"

def receive_message(conn, buffer_size=1024):
    data = []
    while True:
        chunk = conn.recv(buffer_size)
        if not chunk:
            break
        data.append(chunk)
    return b''.join(data).decode('utf-8')

def client(action):
    code = 0
    client = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)

    try:
        client.connect(SOCKET_PATH)
        client.send(action.encode('utf-8'))

        response = receive_message(client)
        print(f"{response}")

        if action == "reload" and response != "success":
             code = 1
             return
    except Exception as e:
        print(f"Error: {e}")
        code = 2
    finally:
        client.close()

    return code

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--reload', action='store_true', help='reload frr')
    parser.add_argument('--show-neighbors', action='store_true', help='show bgp neighbor')
    args = parser.parse_args()

    code = 0
    if args.reload:
        code = client("reload")
    elif args.show_neighbors:
        code = client("show-neighbors")
    sys.exit(code)